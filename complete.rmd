---
title: "Complete Lipid saturation"
author: "Dan Ackerman"
date: "December 14, 2015"
output: html_document
---

Attempting to create dataframe containing full results of August 2015 analysis of SCD1i in vitro veh and dox cells. This dataframe should contain all saturation information about TGs and all different PLs. 

First step, creating combined dataframe. (as previously)
```{r, warning = FALSE}

dat1<-read.table("Input_data_InVitro_0.5%_DMSO_DOXvsVehicle.csv", header=TRUE, sep=",")
dat2<-read.table("Input_data_InVitro_0.5%_SCDi_DOXvsVehicle.csv", header=TRUE, sep=",")

rep1<-read.table("Input_data_InVitro_5%_DMSO_DOXvsVehicle.csv", header=TRUE, sep=",")
rep2<-read.table("Input_data_InVitro_5%_SCDi_DOXvsVehicle.csv", header=TRUE, sep=",")

dat3<-merge(dat1, dat2, by="Label")
rep3<-merge(rep1, rep2, by="Label")
colnames(dat3)<-c(colnames(dat3)[1], paste0("S-", colnames(dat3[2:21])))
colnames(rep3)<-c(colnames(rep3)[1], paste0("R-", colnames(rep3[2:20])))
comb1<-merge(dat3, rep3, by="Label")
library(stringr)
```

Next, trying to extract different patterns for different lipids.

```{r, echo=FALSE}
lipidtype<- as.data.frame(str_match(comb1$Label, "^(.*)\\((.*)"))
comb2<- merge(comb1, lipidtype[,1:2], by.x= "Label", by.y = "V1")
liplist1<- split(comb2, comb2$V2)
del.V2<- function(df){
  df$V2<- NULL
  df
  }
liplist2<-lapply(liplist1, del.V2)

# classifying lipids by number of FA chains
CL1<- c("ChE")
CL2<- c("PC", "PS", "SM", "Cer", "DG", "PE", "PG", "PI")
CL3<- c("TG")

# creating vector of chain lengths by lipid type
chain_no<- c(rep(NA, length(liplist2)))
names(chain_no)<-names(liplist2)
chain_no[names(liplist2) %in% CL1]<- "CL1"
chain_no[names(liplist2) %in% CL2]<- "CL2"
chain_no[names(liplist2) %in% CL3]<- "CL3"

# creating strings for str_match function to interpret lipid name
  cl1_ch<- "^(.*)\\(([0-9]{1,2}):([0-9])\\)"
  cl2_ch<- "^(.*)\\(([:alpha:]{0,1})([0-9]{1,2}):([0-9])([ep]{0,1})\\/([0-9]{1,2}):([0-9])\\)"
  cl3_ch<- "^(.*)\\(([0-9]{1,2}):([0-9])\\/([0-9]{1,2}):([0-9])/([0-9]{1,2}):([0-9])\\)"
  
# creating function that interprets lipid name and breaks it down
# uses different strings for different lipids
CL.split<- function(df, cl){
  if(cl=="CL1"){
    chains<- cl1_ch
    nms<- c("Label", "Species", "ch1", "ch1DBs")
    } 
  if(cl=="CL2"){
    chains<- cl2_ch
    nms<- c("Label", "Species", "Add1", "ch1", "ch1DBs","Add2", "ch2", "ch2DBs")
  }
  if(cl=="CL3"){
    chains<- cl3_ch
    nms<- c("Label", "Species", "ch1", "ch1DBs", "ch2", "ch2DBs", "ch3", "ch3DBs")
    ##why do CL1 and CL3 not contain Add1 column?
  }
  #else stop("unknown chain number") # doesn't work with this 
  
  FA_chains<- as.data.frame(str_match(df$Label, chains))
  colnames(FA_chains)<- nms
  merge(df, FA_chains, by="Label")
}


satlist1<- Map(CL.split, liplist2, chain_no) #applying function to list
# b<-satlist1[["TG"]]

 
```

Next, adding total amount of lipid with differnt levels of saturation

```{r}

require(data.table); require(tidyr)
tot.unsat2<- function(df, cl){
    if (!"ch1DBs" %in% names(df)){
    stop("df must contain ch1DBs column")
  }
  exclude<- c('Label',"ch1", "ch1DBs", "Species")
  if(cl=="CL1"){
    df$unsat<- as.numeric(as.character(df$ch1DBs))
  }
  if(cl=="CL2"){
    df$unsat<- as.numeric(as.character(df$ch1DBs))+as.numeric(as.character(df$ch2DBs))
    exclude<- c(exclude, c("ch2", "ch2DBs", "Add1", "Add2"))
  }
    if(cl=="CL3"){
    df$unsat<- as.numeric(as.character(df$ch1DBs))+as.numeric(as.character(df$ch2DBs))+ as.numeric(df$ch3DBs)
    exclude<- c(exclude, c("ch2", "ch2DBs", "ch3", "ch3DBs"))
    }
   df2<-setDT(df)[,lapply(.SD, sum), by=unsat, .SDcols=-exclude]
   df2
}

satlist2<- Map(tot.unsat2, satlist1, chain_no)
#tg3<- satlist2[["TG"]]
```


Next, I would like to divide each value by the total amount of that particular lipid species in that sample.

```{r}
# scaling each sample to look at distribution of each lipid as percentage shift
# does not take into account changes in abundance of different lipid species across groups

scal<- function(DAT){
  x<-DAT$unsat
  nms<- colnames(DAT)
  df2<-sweep(DAT,2,colSums(DAT), "/")
  df2$unsat<- x
  colnames(df2)<- nms
  df2[order(df2$unsat),]
}
satlist3<- lapply(satlist2, scal)
#p1<- satlist3[["TG"]]


```

Next, center to look at effect of a treatment on distribution as shift


```{r}

centr<- function(df, controls){
  # takes a dataframe and a vector of sample names
  # calculates mean of each saturatio value across control samples
  # subtracts mean from all values
  df_ctrl<- df[,names(df) %in% controls]
  df2<- sweep(df, 1, rowMeans(df_ctrl), "-")
  df2$unsat<- df$unsat
  df2
}
# center around R-STD_Veh group
conts1<- names(satlist3[["PC"]])[22:26]
R_centlist<- lapply(satlist3, centr, conts1)

#tg1<-R_centlist[["TG"]]  
  
# p2<-centr(satlist3[["PC"]], conts1)
# identical(R_centlist[["PC"]], p2)


require(tidyr); require(ggplot2)

diff.plot<- function(df, exclude=c(), order=c()){
  ## function that takes centered dataframe created by centr()
  ## converts into long format
  ## graphs it in ggplot2
  ## contains argument that takes list of column names to exclude
  ## contains argument that allows user to decide which order to graph in (levels for ggplot2)
  ## naming of samples has to be as follows:
  ### column names match group names with "_1", "_2", etc to identify individual samples
  
    long_df<- gather(df, Sample, Measurement, 2:length(colnames(df)))
    long_df$Group<-unlist(strsplit(as.character(long_df$Sample), '[1-5]$'))
    long_df$Group<- gsub("_$", "", long_df$Group)
    long_df2<- long_df[!(long_df$Sample %in% exclude),]
    try(long_df2$Group<- factor(long_df2$Group, levels = order))
    ##plotting  
    p<-ggplot(long_df2, 
      aes(x=factor(unsat), y=Measurement, fill= factor(Group)))
    p<- p +    geom_boxplot()
    p<- p + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +  labs(x="Double Bonds")
    p
}

plot_list1<- lapply(R_centlist, diff.plot)
order1<- c("R-STD_Veh", "R-STD_SCDi", "R-DOX_Veh", "R-DOX_SCDi", 
           "S-STD_Veh", "S-STD_SCDi", "S-DOX_Veh", "S-DOX_SCDi")
exclude1<- c()
plot_list1<- lapply(R_centlist, diff.plot, exclude1, order1)
# plot_list1[["TG"]]

for (i in names(plot_list1)){
  plot_list2<- vector("list", length(names(plot_list1)))
  plot_list2[[i]]<-plot_list1[[i]]+ ggtitle(paste("Changes in saturation of", i, "species"))
  }
  
plot_list2<- vector("list", length(names(plot_list1)))
names(plot_list2)<- names(plot_list1)
for (i in names(plot_list1)){
  plot_list2[[i]]<-plot_list1[[i]]+ ggtitle(paste("Changes in saturation of", i, "species"))
  }

for (i in names(plot_list2)){
  print(plot_list2[[i]])
  }

plot_list2[["TG"]]


```

Next I want to make publishable figures that illustrate the changes in saturation from two samples

```{r}
se <- function(x) sqrt(var(x)/length(x))

mneffect<- function(df, control, treatment){
  #function that graphs changes in saturation profile between two groups
  #takes a dataframe and two strings of column names
  #output is gg barplot
  
  #### include some stop options if control and treatment columns are not present in names(df)
  
  df_control<- df[, names(df) %in% control]
  df_treat<- df[, names(df) %in% treatment]
  df_diff<- sweep(df_treat, 1, rowMeans(df_control), "-")
  
  ##Create df with all the data required for ggplot
  df_diff2<- data.frame(DBs=df[,1])
  df_diff2$mean<- apply(df_diff,1,mean)
  df_diff2$sd<- apply(df_diff,1,se)
  df_diff2$ctrlmn<- rowMeans(df_control)

  

    z<- ggplot(df_diff2, aes(x=DBs, y=mean, fill=mean>0))+
       geom_bar(stat="identity", position="identity", color="black", size=0.5)+
      geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))+
      scale_x_continuous(breaks=seq(0,9,1))+
      scale_y_continuous(breaks=seq(-0.1,0.3,0.05))+
      scale_fill_manual(values=c("#CCEEFF", "#FFDDDD"), guide=FALSE) +
      geom_hline(aes(yintercept=0))+labs(y="relative change")+
      coord_cartesian(xlim = c(0.5, 8.5), ylim=c(-.2, 0.45))+
      theme(axis.title.x=element_text(size = 25), axis.text.x=element_text(size=30),
        axis.title.y=element_text(size = 25), axis.text.y=element_text(size=30))+
      theme_bw()+
  
    geom_point(aes(size=ctrlmn, x= DBs, y=0.35), 
               shape = 21, color= "black", fill= "cornsilk")+
        scale_size_area(max_size=6.5, guide=FALSE)+
        annotate("text", x=4.5, y=0.43, label= "TG species", size=5)+
        annotate("text", x=4.5, y=0.39, label= "Abundance", size=3.5)
  z  
    
}

mneffect2<- function(df, control, treatment){
  #function that graphs changes in saturation profile between two groups
  #takes a dataframe and two strings of column names
  #output is gg barplot
  
  #### include some stop options if control and treatment columns are not present in names(df)
  
  df_control<- df[, names(df) %in% control]
  df_treat<- df[, names(df) %in% treatment]
  df_diff<- sweep(df_treat, 1, rowMeans(df_control), "-")
  
  ##Create df with all the data required for ggplot
  df_diff2<- data.frame(DBs=df[,1])
  df_diff2$mean<- apply(df_diff,1,mean)
  df_diff2$sd<- apply(df_diff,1,se)
  df_diff2$ctrlmn<- rowMeans(df_control)

  

    z<- ggplot(df_diff2, aes(x=DBs, y=mean, fill=mean>0))+
       geom_bar(stat="identity", position="identity", color="black", size=0.5)+
      geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))
        z  
    
}



TG_effects<- function(lst, grp1, grp2){
  ## takes two text strings, identifies columns in df with those names
  ## takes list, extracts "TG" element as dataframe
  ## performs mneffect() function on those columns
  
  df<-lst[["TG"]]
  cols1<- grep(grp1, names(df), value=TRUE)
  cols2<- grep(grp2, names(df), value=TRUE)
  p<- mneffect2(df, cols1, cols2)
  p
}

# rSTD_Veh<- grep("R-STD_Veh", names(satlist3[["TG"]]), value=TRUE)
# sSTD_Veh<- grep("S-STD_Veh", names(satlist3[["TG"]]), value=TRUE)
# 
# mneffect(satlist3[["TG"]], rSTD_Veh, sSTD_Veh)

serum_effect<-TG_effects(satlist3, "R-STD_Veh", "S-STD_Veh")
TG_effects(satlist3, "R-STD_Veh", "R-DOX_Veh")
TG_effects(satlist3, "R-STD_Veh", "R-STD_SCDi")
TG_effects(satlist3, "R-DOX_Veh", "R-DOX_SCDi")


TG_effects(satlist3, "S-STD_Veh", "S-DOX_Veh")
TG_effects(satlist3, "S-STD_Veh", "S-STD_SCDi")
TG_effects(satlist3, "S-DOX_Veh", "S-DOX_SCDi")

names(satlist3[["TG"]])

serum_effect2<-TG_effects(satlist3, "R-STD_Veh", "S-STD_Veh")

# svg("./20160125/TG_serum_effect.svg", width=4)
# serum_effect2 +  scale_x_continuous(breaks=seq(0,9,1))+
#       scale_y_continuous(breaks=seq(-0.1,0.15,0.05))+
#       scale_fill_manual(values=c("#CCEEFF", "#FFDDDD"), guide=FALSE) +
#       geom_hline(aes(yintercept=0))+labs(y="relative change")+
#       coord_cartesian(xlim = c(0.5, 8.5), ylim=c(-0.075, 0.12))+
#       theme(axis.title.x=element_text(size = 25), axis.text.x=element_text(size=30),
#         axis.title.y=element_text(size = 25), axis.text.y=element_text(size=30))+
#       theme_bw() + geom_point(aes(size=ctrlmn, x= DBs, y=0.11), shape = 21, color= "black", fill= "cornsilk")+
#         scale_size_area(max_size=6.5, guide=FALSE)+
#         annotate("text", x=4.5, y=0.085, label= "Change in TG saturation", size=5)+
#         annotate("text", x=4.5, y=0.12, label= "Abundance", size=5)
# dev.off()
### can't seem to be able to import svg into illustrator

serum_effect3<- serum_effect2 +  scale_x_continuous(breaks=seq(0,9,1))+
      scale_y_continuous(breaks=seq(-0.1,0.15,0.05))+
      scale_fill_manual(values=c("#CCEEFF", "#FFDDDD"), guide=FALSE) +
      geom_hline(aes(yintercept=0))+labs(y="relative change")+
      coord_cartesian(xlim = c(0.5, 8.5), ylim=c(-0.075, 0.12))+
      theme(axis.title.x=element_text(size = 25), axis.text.x=element_text(size=30),
        axis.title.y=element_text(size = 25), axis.text.y=element_text(size=30))+
      theme_bw() + geom_point(aes(size=ctrlmn, x= DBs, y=0.11), shape = 21, color= "black", fill= "cornsilk")+
        scale_size_area(max_size=6.5, guide=FALSE)+
        annotate("text", x=4.5, y=0.085, label= "Change in TG saturation", size=5)+
        annotate("text", x=4.5, y=0.12, label= "Abundance", size=5)

ggsave("./20160125/TG_serum_effect.pdf", plot = serum_effect3, width=4, height=4)

